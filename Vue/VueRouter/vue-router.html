<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Vue-Router | 余生的前端笔记本</title>
    <meta name="generator" content="VuePress 1.5.0">
    <link rel="shortcut icon" href="favicon.ico">
    <meta name="description" content="记录平凡">
    <link rel="preload" href="/xn213/assets/css/0.styles.ca63e153.css" as="style"><link rel="preload" href="/xn213/assets/js/app.d4906252.js" as="script"><link rel="preload" href="/xn213/assets/js/2.51fac5b8.js" as="script"><link rel="preload" href="/xn213/assets/js/108.8560db9a.js" as="script"><link rel="prefetch" href="/xn213/assets/js/10.1faf398f.js"><link rel="prefetch" href="/xn213/assets/js/100.7a74ebc8.js"><link rel="prefetch" href="/xn213/assets/js/101.4f40be2a.js"><link rel="prefetch" href="/xn213/assets/js/102.c8d7cea6.js"><link rel="prefetch" href="/xn213/assets/js/103.270122d2.js"><link rel="prefetch" href="/xn213/assets/js/104.d4a4e842.js"><link rel="prefetch" href="/xn213/assets/js/105.3f397b90.js"><link rel="prefetch" href="/xn213/assets/js/106.918e93a8.js"><link rel="prefetch" href="/xn213/assets/js/107.bed93497.js"><link rel="prefetch" href="/xn213/assets/js/109.3d45cd73.js"><link rel="prefetch" href="/xn213/assets/js/11.6bf048df.js"><link rel="prefetch" href="/xn213/assets/js/110.1a0c24e2.js"><link rel="prefetch" href="/xn213/assets/js/111.3fecca9a.js"><link rel="prefetch" href="/xn213/assets/js/112.4acafde9.js"><link rel="prefetch" href="/xn213/assets/js/113.0138919a.js"><link rel="prefetch" href="/xn213/assets/js/114.b6f3a7bb.js"><link rel="prefetch" href="/xn213/assets/js/115.03d6018c.js"><link rel="prefetch" href="/xn213/assets/js/116.9da7bcd2.js"><link rel="prefetch" href="/xn213/assets/js/117.b00f571c.js"><link rel="prefetch" href="/xn213/assets/js/118.805693d4.js"><link rel="prefetch" href="/xn213/assets/js/12.1366bf4e.js"><link rel="prefetch" href="/xn213/assets/js/13.8469840d.js"><link rel="prefetch" href="/xn213/assets/js/14.476bf2b4.js"><link rel="prefetch" href="/xn213/assets/js/15.73262e19.js"><link rel="prefetch" href="/xn213/assets/js/16.a84e4240.js"><link rel="prefetch" href="/xn213/assets/js/17.3be54d85.js"><link rel="prefetch" href="/xn213/assets/js/18.500d10d8.js"><link rel="prefetch" href="/xn213/assets/js/19.8474792d.js"><link rel="prefetch" href="/xn213/assets/js/20.c4c313bc.js"><link rel="prefetch" href="/xn213/assets/js/21.b0881497.js"><link rel="prefetch" href="/xn213/assets/js/22.d5268e49.js"><link rel="prefetch" href="/xn213/assets/js/23.58ca6578.js"><link rel="prefetch" href="/xn213/assets/js/24.a3e7d50c.js"><link rel="prefetch" href="/xn213/assets/js/25.16abe053.js"><link rel="prefetch" href="/xn213/assets/js/26.86c0a1e4.js"><link rel="prefetch" href="/xn213/assets/js/27.7030e691.js"><link rel="prefetch" href="/xn213/assets/js/28.deb79169.js"><link rel="prefetch" href="/xn213/assets/js/29.6eaaf04b.js"><link rel="prefetch" href="/xn213/assets/js/3.b7850748.js"><link rel="prefetch" href="/xn213/assets/js/30.2506a5c4.js"><link rel="prefetch" href="/xn213/assets/js/31.26cfc1d9.js"><link rel="prefetch" href="/xn213/assets/js/32.0a4b2fe0.js"><link rel="prefetch" href="/xn213/assets/js/33.36d9b152.js"><link rel="prefetch" href="/xn213/assets/js/34.2b9dc880.js"><link rel="prefetch" href="/xn213/assets/js/35.2567933d.js"><link rel="prefetch" href="/xn213/assets/js/36.23821499.js"><link rel="prefetch" href="/xn213/assets/js/37.46a4d915.js"><link rel="prefetch" href="/xn213/assets/js/38.78a550d5.js"><link rel="prefetch" href="/xn213/assets/js/39.d61eb27d.js"><link rel="prefetch" href="/xn213/assets/js/4.7e99a2d3.js"><link rel="prefetch" href="/xn213/assets/js/40.933a08eb.js"><link rel="prefetch" href="/xn213/assets/js/41.a470035a.js"><link rel="prefetch" href="/xn213/assets/js/42.fc89c186.js"><link rel="prefetch" href="/xn213/assets/js/43.15247d93.js"><link rel="prefetch" href="/xn213/assets/js/44.ab9e5f68.js"><link rel="prefetch" href="/xn213/assets/js/45.d347fb15.js"><link rel="prefetch" href="/xn213/assets/js/46.3dbf0169.js"><link rel="prefetch" href="/xn213/assets/js/47.bc6372ae.js"><link rel="prefetch" href="/xn213/assets/js/48.a455dd6a.js"><link rel="prefetch" href="/xn213/assets/js/49.42512fc4.js"><link rel="prefetch" href="/xn213/assets/js/5.9753c03c.js"><link rel="prefetch" href="/xn213/assets/js/50.d154eba7.js"><link rel="prefetch" href="/xn213/assets/js/51.615c6988.js"><link rel="prefetch" href="/xn213/assets/js/52.826146fc.js"><link rel="prefetch" href="/xn213/assets/js/53.86dca864.js"><link rel="prefetch" href="/xn213/assets/js/54.5537cce4.js"><link rel="prefetch" href="/xn213/assets/js/55.7e134c54.js"><link rel="prefetch" href="/xn213/assets/js/56.84100376.js"><link rel="prefetch" href="/xn213/assets/js/57.6b67fd76.js"><link rel="prefetch" href="/xn213/assets/js/58.9b9f3130.js"><link rel="prefetch" href="/xn213/assets/js/59.f3e68bcf.js"><link rel="prefetch" href="/xn213/assets/js/6.a4f112fa.js"><link rel="prefetch" href="/xn213/assets/js/60.a4243a5c.js"><link rel="prefetch" href="/xn213/assets/js/61.29628b38.js"><link rel="prefetch" href="/xn213/assets/js/62.3f0b67b9.js"><link rel="prefetch" href="/xn213/assets/js/63.910061cb.js"><link rel="prefetch" href="/xn213/assets/js/64.48d637e0.js"><link rel="prefetch" href="/xn213/assets/js/65.a11ce1db.js"><link rel="prefetch" href="/xn213/assets/js/66.c7d82608.js"><link rel="prefetch" href="/xn213/assets/js/67.ee9cd709.js"><link rel="prefetch" href="/xn213/assets/js/68.37ca6255.js"><link rel="prefetch" href="/xn213/assets/js/69.fb07e58e.js"><link rel="prefetch" href="/xn213/assets/js/7.f165d4ad.js"><link rel="prefetch" href="/xn213/assets/js/70.c6515a0e.js"><link rel="prefetch" href="/xn213/assets/js/71.c6d65667.js"><link rel="prefetch" href="/xn213/assets/js/72.edd126d5.js"><link rel="prefetch" href="/xn213/assets/js/73.c8230ab6.js"><link rel="prefetch" href="/xn213/assets/js/74.9169bdfa.js"><link rel="prefetch" href="/xn213/assets/js/75.7f969006.js"><link rel="prefetch" href="/xn213/assets/js/76.7f70450f.js"><link rel="prefetch" href="/xn213/assets/js/77.84b9567f.js"><link rel="prefetch" href="/xn213/assets/js/78.ec259083.js"><link rel="prefetch" href="/xn213/assets/js/79.0f38cf96.js"><link rel="prefetch" href="/xn213/assets/js/8.93badb4c.js"><link rel="prefetch" href="/xn213/assets/js/80.00d59f1a.js"><link rel="prefetch" href="/xn213/assets/js/81.296081e7.js"><link rel="prefetch" href="/xn213/assets/js/82.1a7bb394.js"><link rel="prefetch" href="/xn213/assets/js/83.49934a5f.js"><link rel="prefetch" href="/xn213/assets/js/84.8302d481.js"><link rel="prefetch" href="/xn213/assets/js/85.5b6eca11.js"><link rel="prefetch" href="/xn213/assets/js/86.9cd3ce36.js"><link rel="prefetch" href="/xn213/assets/js/87.909f3fbe.js"><link rel="prefetch" href="/xn213/assets/js/88.97d3b017.js"><link rel="prefetch" href="/xn213/assets/js/89.eb9b8edc.js"><link rel="prefetch" href="/xn213/assets/js/9.48527424.js"><link rel="prefetch" href="/xn213/assets/js/90.81ddc649.js"><link rel="prefetch" href="/xn213/assets/js/91.ea383d56.js"><link rel="prefetch" href="/xn213/assets/js/92.31ffb78c.js"><link rel="prefetch" href="/xn213/assets/js/93.6f5a3c6c.js"><link rel="prefetch" href="/xn213/assets/js/94.3092c543.js"><link rel="prefetch" href="/xn213/assets/js/95.1396fb1e.js"><link rel="prefetch" href="/xn213/assets/js/96.d7c769c9.js"><link rel="prefetch" href="/xn213/assets/js/97.5c6b604b.js"><link rel="prefetch" href="/xn213/assets/js/98.417f15c6.js"><link rel="prefetch" href="/xn213/assets/js/99.c8d339c0.js">
    <link rel="stylesheet" href="/xn213/assets/css/0.styles.ca63e153.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/xn213/" class="home-link router-link-active"><!----> <span class="site-name">余生的前端笔记本</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/xn213/Computer/" class="nav-link">
  计算机
</a></div><div class="nav-item"><a href="/xn213/Frontend/" class="nav-link">
  大前端
</a></div><div class="nav-item"><a href="/xn213/Notes/" class="nav-link">
  Notes
</a></div><div class="nav-item"><a href="/xn213/Interview/" class="nav-link">
  Interview
</a></div><div class="nav-item"><a href="/xn213/JS/" class="nav-link">
  JS
</a></div><div class="nav-item"><a href="/xn213/CSS/" class="nav-link">
  CSS
</a></div><div class="nav-item"><a href="/xn213/Vue/VueBasic/VueRespond.html" class="nav-link">
  Vue
</a></div><div class="nav-item"><a href="/xn213/React/" class="nav-link">
  React
</a></div><div class="nav-item"><a href="/xn213/CodeTools/VSCode/VSCodeVue.html" class="nav-link">
  CodeTools
</a></div><div class="nav-item"><a href="/xn213/DZH/Explain.html" class="nav-link">
  大杂烩
</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/xn213/Computer/" class="nav-link">
  计算机
</a></div><div class="nav-item"><a href="/xn213/Frontend/" class="nav-link">
  大前端
</a></div><div class="nav-item"><a href="/xn213/Notes/" class="nav-link">
  Notes
</a></div><div class="nav-item"><a href="/xn213/Interview/" class="nav-link">
  Interview
</a></div><div class="nav-item"><a href="/xn213/JS/" class="nav-link">
  JS
</a></div><div class="nav-item"><a href="/xn213/CSS/" class="nav-link">
  CSS
</a></div><div class="nav-item"><a href="/xn213/Vue/VueBasic/VueRespond.html" class="nav-link">
  Vue
</a></div><div class="nav-item"><a href="/xn213/React/" class="nav-link">
  React
</a></div><div class="nav-item"><a href="/xn213/CodeTools/VSCode/VSCodeVue.html" class="nav-link">
  CodeTools
</a></div><div class="nav-item"><a href="/xn213/DZH/Explain.html" class="nav-link">
  大杂烩
</a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Vue 基础</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>VueJs 项目实践</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Vue Component</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>Vue Router</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/xn213/Vue/VueRouter/vue-router.html" class="active sidebar-link">Vue-Router</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/xn213/Vue/VueRouter/vue-router.html#前言" class="sidebar-link">前言</a></li><li class="sidebar-sub-header"><a href="/xn213/Vue/VueRouter/vue-router.html#导航守卫实践与解析" class="sidebar-link">导航守卫实践与解析</a></li><li class="sidebar-sub-header"><a href="/xn213/Vue/VueRouter/vue-router.html#项目实践" class="sidebar-link">项目实践</a></li><li class="sidebar-sub-header"><a href="/xn213/Vue/VueRouter/vue-router.html#源码解析" class="sidebar-link">源码解析</a></li><li class="sidebar-sub-header"><a href="/xn213/Vue/VueRouter/vue-router.html#总结" class="sidebar-link">总结</a></li></ul></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Vuex</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Vue 移动端</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Vue 遇到的问题</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Vue 源码</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/xn213/Vue/Vue/vue-prototype.html" class="sidebar-link">Vue 构造函数整理-原型</a></li><li><a href="/xn213/Vue/Vue/vue-global-api.html" class="sidebar-link">Vue 构造函数整理-全局API</a></li><li><a href="/xn213/Vue/Vue/vue-ins.html" class="sidebar-link">Vue 实例的设计</a></li><li><a href="/xn213/Vue/Vue/从源码学习之Vue面试题目.html" class="sidebar-link">Vue 从源码学习之面试题目</a></li><li><a href="/xn213/Vue/Vue/Vue源码中的高级js.html" class="sidebar-link">Vue 从源码学习之 JS 骚操作</a></li><li><a href="/xn213/Vue/Vue/vue-props.html" class="sidebar-link">Vue 从源码学习之 Vue选项Props</a></li><li><a href="/xn213/Vue/Vue/shared-util.html" class="sidebar-link">shared/util.js 文件工具方法全解</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="vue-router"><a href="#vue-router" class="header-anchor">#</a> Vue-Router</h1> <h2 id="前言"><a href="#前言" class="header-anchor">#</a> 前言</h2> <h3 id="阅读-vue-router-源码的思维导图"><a href="#阅读-vue-router-源码的思维导图" class="header-anchor">#</a> <a href="https://sailor-1256168624.cos.ap-chengdu.myqcloud.com/blog/vue-router.png" target="_blank" rel="noopener noreferrer">阅读 vue-router 源码的思维导图<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></h3> <p><img src="https://cdn.nlark.com/yuque/0/2019/png/197530/1553240619863-fa042dbe-fab1-4624-a933-cf4b50aa8488.png?x-oss-process=image/resize,w_1492" alt="vue-router"></p> <p><a href="https://router.vuejs.org/zh/" target="_blank" rel="noopener noreferrer">vue-router 的文档<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 对辅助看源码有不小的帮助，不妨在看源码之前仔细地撸一遍文档。</p> <h2 id="导航守卫实践与解析"><a href="#导航守卫实践与解析" class="header-anchor">#</a> 导航守卫实践与解析</h2> <p><code>vue-router</code> 提供的导航守卫主要用来通过跳转或取消的方式守卫导航。我们能够在全局、单个路由、单个组件内增加导航守卫，对于路由事件的处理非常灵活。</p> <p>导航守卫有以下几种：</p> <ul><li>全局前置守卫 beforeEach</li> <li>全局解析守卫 beforeResolve</li> <li>全局后置钩子 afterEach</li> <li>路由前置守卫 beforeEnter</li> <li>组件前置守卫 beforeRouteEnter</li> <li>组件更新钩子 beforeRouteUpdate</li> <li>组件后置钩子 beforeRouteLeave</li></ul> <p>beforeResolve、beforeResolve、beforeRouteEnter、beforeRouteLeave 这几个导航守卫，个人在项目中还没有特别好的实践，希望小伙伴们在评论区留下你的想法。</p> <p><a href="https://router.vuejs.org/zh/guide/advanced/navigation-guards.html#%E5%AF%BC%E8%88%AA%E5%AE%88%E5%8D%AB" target="_blank" rel="noopener noreferrer">导航守卫 | Vue Router<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <h2 id="项目实践"><a href="#项目实践" class="header-anchor">#</a> 项目实践</h2> <p>在项目中我们可以利用全局前置守卫 beforeEach 进行路由验证，通过全局守卫 beforeEach 和 afterEach 控制进度条打开和关闭，通过导航守卫对单个路由、组件路由进行处理。</p> <h3 id="登录验证"><a href="#登录验证" class="header-anchor">#</a> 登录验证</h3> <p>我们一般用 beforeEach 这个全局前置守卫来做路由跳转前的登录验证。</p> <p>来看一下具体配置：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>constrouter<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">VueRouter</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  routes<span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      path<span class="token operator">:</span> <span class="token string">'/login'</span><span class="token punctuation">,</span>
      name<span class="token operator">:</span> <span class="token string">'login'</span><span class="token punctuation">,</span>
      meta<span class="token operator">:</span> <span class="token punctuation">{</span> name<span class="token operator">:</span> <span class="token string">'登录'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token function-variable function">component</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">import</span><span class="token punctuation">(</span><span class="token string">'./views/login.vue'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      path<span class="token operator">:</span> <span class="token string">'/welcome'</span><span class="token punctuation">,</span>
      name<span class="token operator">:</span> <span class="token string">'welcome'</span><span class="token punctuation">,</span>
      meta<span class="token operator">:</span> <span class="token punctuation">{</span> name<span class="token operator">:</span> <span class="token string">'欢迎'</span><span class="token punctuation">,</span> auth<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token function-variable function">component</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">import</span><span class="token punctuation">(</span><span class="token string">'./views/welcome.vue'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p>在上面的 routers 中我们配置了 2 个路由，login 和 welcome，welcome 需要登录认证，我们在 welcome 路由的 meta 中加入了 <code>auth: true</code> 作为需要认证的标识。</p> <p>beforeEach 全局前置守卫的配置：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>router<span class="token punctuation">.</span><span class="token function">beforeEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">to<span class="token punctuation">,</span> <span class="token keyword">from</span><span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>to<span class="token punctuation">.</span>meta<span class="token punctuation">.</span>auth<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">getToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token function">next</span><span class="token punctuation">(</span><span class="token string">'/login'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>在 beforeEach 中，router 会按照创建顺序调用，如果 getToken 能够获取到 token，我们就让路由跳转到 to 所对应的 path，否则强制跳转到 login 路由，进行登录认证。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>importCookies <span class="token keyword">from</span> <span class="token string">'js-cookie'</span>
<span class="token keyword">const</span> TokenKey <span class="token operator">=</span> <span class="token string">'TOKEN_KEY'</span>

<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">getToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> Cookies<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>TokenKey<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p><strong>PS: getToken 函数引用 <code>js-cookie</code> 库，用来获取 cookie 中的 token 。</strong></p> <h3 id="进度条"><a href="#进度条" class="header-anchor">#</a> 进度条</h3> <p>我们采用 <code>NProgress.js</code> 轻量级的进度条组件，支持自定义配置。</p> <p><a href="https://github.com/rstacruz/nprogress/" target="_blank" rel="noopener noreferrer">NProgress.js<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>importNProgressfrom <span class="token string">'nprogress'</span>

NProgress<span class="token punctuation">.</span><span class="token function">configure</span><span class="token punctuation">(</span><span class="token punctuation">{</span> showSpinner<span class="token operator">:</span> <span class="token boolean">false</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">// 全局前置守卫</span>
router<span class="token punctuation">.</span><span class="token function">beforeEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">to<span class="token punctuation">,</span> <span class="token keyword">from</span><span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  NProgress<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">// 全局后置钩子</span>
router<span class="token punctuation">.</span><span class="token function">afterEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  NProgress<span class="token punctuation">.</span><span class="token function">done</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>我们通过在全局后置钩子 beforeEach、全局前置守卫 afterEach 的回调中调用 NProgress 暴露的 start、done 函数，来控制进度条的显示和隐藏。</p> <h3 id="组件守卫"><a href="#组件守卫" class="header-anchor">#</a> 组件守卫</h3> <div class="language-js line-numbers-mode"><pre class="language-js"><code>constFoo<span class="token operator">=</span> <span class="token punctuation">{</span>
  template<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">...</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
  <span class="token function">created</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'this is created'</span><span class="token punctuation">)</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">searchData</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function">mounted</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'this is mounted'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function">updated</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'this is updated'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function">destroyed</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'this is destroyed'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function">beforeRouteUpdate</span><span class="token punctuation">(</span><span class="token parameter">to<span class="token punctuation">,</span> <span class="token keyword">from</span><span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><p>带有动态参数的路径 <code>/foo/:id</code>，在 <code>/foo/1</code> 和 <code>/foo/2</code> 之间跳转的时候，由于会渲染同样的 Foo 组件，因此组件实例会被复用。此时组件内的生命周期 created、mounted、destroyed、updated 均不会执行。</p> <p>在 vue 文档中这样解释: <em>由于数据更改导致的虚拟 DOM 重新渲染和打补丁，在这之后会调用该钩子。</em></p> <p>__</p> <p>但是我们只想监听路由变化呢，那么就得用到 beforeRouteUpdate 组件导航守卫。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>constFoo <span class="token operator">=</span> <span class="token punctuation">{</span>
  template<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">...</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
  <span class="token function">beforeRouteUpdate</span><span class="token punctuation">(</span><span class="token parameter">to<span class="token punctuation">,</span> <span class="token keyword">from</span><span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">searchData</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>在 <code>/foo/1</code> 和 <code>/foo/2</code> 之间跳转的时候，会调用 <code>this.searchData()</code> 函数更新数据。</p> <h2 id="源码解析"><a href="#源码解析" class="header-anchor">#</a> 源码解析</h2> <p>那么既然 router 的导航守卫这么神奇，那在 <code>vue-router</code> 中是怎么实现的呢？</p> <h3 id="阅读-vue-router-源码的思维导图-2"><a href="#阅读-vue-router-源码的思维导图-2" class="header-anchor">#</a> <a href="https://sailor-1256168624.cos.ap-chengdu.myqcloud.com/blog/vue-router.png" target="_blank" rel="noopener noreferrer">阅读 vue-router 源码的思维导图<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></h3> <p><img src="https://cdn.nlark.com/yuque/0/2019/png/197530/1553240619863-fa042dbe-fab1-4624-a933-cf4b50aa8488.png?x-oss-process=image/resize,w_1492" alt=""></p> <p><a href="https://router.vuejs.org/zh/" target="_blank" rel="noopener noreferrer">vue-router 的文档<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 对辅助看源码有不小的帮助，不妨在看源码之前仔细地撸一遍文档。</p> <h3 id="vuerouter"><a href="#vuerouter" class="header-anchor">#</a> VueRouter</h3> <p>在 <code>vue-router</code> 的 <code>index.js</code> 中默认导出了 VueRouter 类。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>exportdefaultclassVueRouter <span class="token punctuation">{</span>
  <span class="token function">constructor</span> <span class="token punctuation">(</span><span class="token parameter">options<span class="token operator">:</span> RouterOptions <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token operator">...</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>beforeHooks <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>resolveHooks <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>afterHooks <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 全局前置守卫</span>
  <span class="token function">beforeEach</span> <span class="token punctuation">(</span>fn<span class="token operator">:</span> Function<span class="token punctuation">)</span><span class="token operator">:</span> Function <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">registerHook</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>beforeHooks<span class="token punctuation">,</span> fn<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 全局解析守卫</span>
  <span class="token function">beforeResolve</span> <span class="token punctuation">(</span>fn<span class="token operator">:</span> Function<span class="token punctuation">)</span><span class="token operator">:</span> Function <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">registerHook</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>resolveHooks<span class="token punctuation">,</span> fn<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 全局后置钩子</span>
  <span class="token function">afterEach</span> <span class="token punctuation">(</span>fn<span class="token operator">:</span> Function<span class="token punctuation">)</span><span class="token operator">:</span> Function <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">registerHook</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>afterHooks<span class="token punctuation">,</span> fn<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><p>在 VueRouter 类中申明了 beforeHooks、resolveHooks、afterHooks 数组用来储存全局的导航守卫函数，还申明了 beforeEach、beforeResolve、afterEach 这 3 个全局的导航守卫函数。</p> <p>在这 3 个全局导航守卫函数中都调用了 registerHook 函数：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">registerHook</span><span class="token punctuation">(</span><span class="token parameter">list<span class="token operator">:</span> Array<span class="token operator">&lt;</span>any<span class="token operator">&gt;</span><span class="token punctuation">,</span> fn<span class="token operator">:</span> Function</span><span class="token punctuation">)</span><span class="token operator">:</span> Function <span class="token punctuation">{</span>
  list<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>fn<span class="token punctuation">)</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> i <span class="token operator">=</span> list<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>fn<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">&gt;</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> list<span class="token punctuation">.</span><span class="token function">splice</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>registerHook 函数会将传入的 fn 守卫函数推入对应的守卫函数队列 list，并返回可以删除此 fn 导航守卫的函数。</p> <h3 id="history"><a href="#history" class="header-anchor">#</a> History</h3> <p>我们先来看看 History 类，在 <code>src/history/base.js</code> 文件。这里主要介绍 2 个核心函数 transitionTo、confirmTransition。</p> <h3 id="核心函数-transitionto"><a href="#核心函数-transitionto" class="header-anchor">#</a> 核心函数 transitionTo</h3> <p>transitionTo 是 router 进行跳转的核心函数，我们来看一下它是如何实现的。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>exportclassHistory <span class="token punctuation">{</span>
  <span class="token operator">...</span><span class="token comment">// 跳转核心处理transitionTo (location: RawLocation, onComplete ?: Function, onAbort ?: Function) {</span>
    <span class="token comment">// 调用 match 函数生成 route 对象</span>
    <span class="token keyword">const</span> route <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>router<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span>location<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>current<span class="token punctuation">)</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">confirmTransition</span><span class="token punctuation">(</span>route<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token comment">// 更新当前 route</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">updateRoute</span><span class="token punctuation">(</span>route<span class="token punctuation">)</span>
      <span class="token comment">// 路由更新后的回调</span>
      <span class="token comment">// 就是 HashHistory类的 setupListeners</span>
      <span class="token comment">// 做了滚动处理 hash 事件监听</span>
      onComplete <span class="token operator">&amp;&amp;</span> <span class="token function">onComplete</span><span class="token punctuation">(</span>route<span class="token punctuation">)</span>
      <span class="token comment">// 更新 url （在子类申明的方法）</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">ensureURL</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token comment">// fire ready cbs once</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>ready<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>ready <span class="token operator">=</span> <span class="token boolean">true</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>readyCbs<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">cb</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> <span class="token function">cb</span><span class="token punctuation">(</span>route<span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token parameter">err</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>onAbort<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">onAbort</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>err <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>ready<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>ready <span class="token operator">=</span> <span class="token boolean">true</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>readyErrorCbs<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">cb</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> <span class="token function">cb</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br></div></div><p>transitionTo 函数接收 3 个函数，location 跳转路由、onComplete 成功回调、onAbort 中止回调。</p> <p>vue-router 的 3 种 history 模式，AbstractHistory、HashHistory、HTML5History 类中都是通过 extends 继承了 History 类的 transitionTo 函数。</p> <p>在 transitionTo 函数中首先会调用 match 函数生成 route 对象：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token punctuation">{</span>
  fullPath<span class="token operator">:</span> <span class="token string">&quot;/&quot;</span>
  hash<span class="token operator">:</span> <span class="token string">&quot;&quot;</span>
  matched<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>…<span class="token punctuation">}</span><span class="token punctuation">]</span>
  meta<span class="token operator">:</span>
  __proto__<span class="token operator">:</span> Object
  name<span class="token operator">:</span> <span class="token keyword">undefined</span>
  params<span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  path<span class="token operator">:</span> <span class="token string">&quot;/&quot;</span>
  query<span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>得到一个路由对象 route，然后调用 this.confirmTransition 函数，传入 route、成功回调、失败回调。</p> <p>在成功回调中会调用 updateRoute 函数：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token function">updateRoute</span> <span class="token punctuation">(</span><span class="token parameter">route<span class="token operator">:</span> Route</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> prev <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>current
  <span class="token keyword">this</span><span class="token punctuation">.</span>current <span class="token operator">=</span> route
  <span class="token keyword">this</span><span class="token punctuation">.</span>cb <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">cb</span><span class="token punctuation">(</span>route<span class="token punctuation">)</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>router<span class="token punctuation">.</span>afterHooks<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">hook</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    hook <span class="token operator">&amp;&amp;</span> <span class="token function">hook</span><span class="token punctuation">(</span>route<span class="token punctuation">,</span> prev<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>updateRoute 函数会更新当前 route，并遍历执行全局后置钩子函数 afterHooks 队列，该队列是通过</p> <p>router 暴露的 afterEach 函数推入的。</p> <p><strong>PS: afterEach 别没有在迭代函数调用，因此没有传入 next 函数。</strong></p> <hr> <p>在失败回调中会调用中止函数 onAbort。</p> <h3 id="确认跳转函数-confirmtransition"><a href="#确认跳转函数-confirmtransition" class="header-anchor">#</a> 确认跳转函数 confirmTransition</h3> <p>confirmTransition 顾名思义，是来确认当前路由是否能够进行跳转，那么在函数内部具体做了哪些事情？</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>exportclassHistory <span class="token punctuation">{</span>
  <span class="token operator">...</span>
  <span class="token function">confirmTransition</span> <span class="token punctuation">(</span><span class="token parameter">route<span class="token operator">:</span> Route<span class="token punctuation">,</span> onComplete<span class="token operator">:</span> Function<span class="token punctuation">,</span> onAbort <span class="token operator">?</span><span class="token operator">:</span> Function</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> current <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>current
    <span class="token comment">// 封装中止函数，循环调用 errorCbs 任务队列</span>
    <span class="token keyword">const</span> <span class="token function-variable function">abort</span> <span class="token operator">=</span> <span class="token parameter">err</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token operator">...</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 路由相同则返回</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>
      <span class="token function">isSameRoute</span><span class="token punctuation">(</span>route<span class="token punctuation">,</span> current<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
      <span class="token comment">// in the case the route map has been dynamically appended to</span>
      route<span class="token punctuation">.</span>matched<span class="token punctuation">.</span>length <span class="token operator">===</span> current<span class="token punctuation">.</span>matched<span class="token punctuation">.</span>length
    <span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">ensureURL</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token keyword">return</span> <span class="token function">abort</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 用 resolveQueue 来做做新旧对比 比较后返回需要更新、激活、卸载 3 种路由状态的数组</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span>
      updated<span class="token punctuation">,</span>
      deactivated<span class="token punctuation">,</span>
      activated
    <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">resolveQueue</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>current<span class="token punctuation">.</span>matched<span class="token punctuation">,</span> route<span class="token punctuation">.</span>matched<span class="token punctuation">)</span>
    <span class="token comment">// 提取守卫的钩子函数 将任务队列合并</span>
    <span class="token keyword">const</span> queue<span class="token operator">:</span> Array<span class="token operator">&lt;</span><span class="token operator">?</span>NavigationGuard<span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span>
      <span class="token comment">// in-component leave guards</span>
      <span class="token comment">// 获得组件内的 beforeRouteLeave 钩子函数</span>
      <span class="token function">extractLeaveGuards</span><span class="token punctuation">(</span>deactivated<span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token comment">// global before hooks</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>router<span class="token punctuation">.</span>beforeHooks<span class="token punctuation">,</span>
      <span class="token comment">// in-component update hooks</span>
      <span class="token comment">// 获得组件内的 beforeRouteUpdate 钩子函数</span>
      <span class="token function">extractUpdateHooks</span><span class="token punctuation">(</span>updated<span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token comment">// in-config enter guards</span>
      activated<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">m</span> <span class="token operator">=&gt;</span> m<span class="token punctuation">.</span>beforeEnter<span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token comment">// async components</span>
      <span class="token comment">// 异步组件处理</span>
      <span class="token function">resolveAsyncComponents</span><span class="token punctuation">(</span>activated<span class="token punctuation">)</span>
    <span class="token punctuation">)</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>pending <span class="token operator">=</span> route
    <span class="token comment">// 申明一个迭代函数，用来处理每个 hook 的 next 回调</span>
    <span class="token keyword">const</span> <span class="token function-variable function">iterator</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">hook<span class="token operator">:</span> NavigationGuard<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token operator">...</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 执行合并后的任务队列</span>
    <span class="token function">runQueue</span><span class="token punctuation">(</span>queue<span class="token punctuation">,</span> iterator<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token operator">...</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br></div></div><p>函数内部首先申明 current 变量，保存当前路由信息，并封装了 abort 中止函数。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// 封装中止函数，循环调用 errorCbs 任务队列constabort= err =&gt; {</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isError</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>errorCbs<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>errorCbs<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">cb</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token function">cb</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token function">warn</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token string">'uncaught error during route navigation:'</span><span class="token punctuation">)</span>
      console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  onAbort <span class="token operator">&amp;&amp;</span> <span class="token function">onAbort</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>abort 函数接收 err 参数，如果传入了 err 会执行 this.errorCbs 推入的 error 任务，并且执行 onAbort 中止函数。</p> <p>接着会判断当前路由与跳转路由是否相同，如果相同，返回并执行中止函数 abort。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token punctuation">{</span> updated<span class="token punctuation">,</span> deactivated<span class="token punctuation">,</span> activated <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">resolveQueue</span><span class="token punctuation">(</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>current<span class="token punctuation">.</span>matched<span class="token punctuation">,</span>
  route<span class="token punctuation">.</span>matched
<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>这里会调用 resolveQueue 函数，将当前的 matched 与跳转的 matched 进行比较，matched 是在 <code>src/util/route.js</code> 中 createRoute 函数中增加，用数组的形式记录当前 route 以及它的上级 route。</p> <p>resolveQueue 函数主要用来做新旧对比，通过遍历 matched 数组，比较后返回需要更新、激活、卸载 3 种路由状态的数组。</p> <p>接下来会有一个关键的操作，将所有的导航守卫函数合并成一个 queue 的任务队列。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// 提取守卫的钩子函数 将任务队列合并constqueue: Array&lt;?NavigationGuard&gt; = [].concat(</span>
  <span class="token comment">// in-component leave guards</span>
  <span class="token comment">// 获得组件内的 beforeRouteLeave 钩子函数</span>
  <span class="token function">extractLeaveGuards</span><span class="token punctuation">(</span>deactivated<span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token comment">// global before hooks</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>router<span class="token punctuation">.</span>beforeHooks<span class="token punctuation">,</span>
  <span class="token comment">// in-component update hooks</span>
  <span class="token comment">// 获得组件内的 beforeRouteUpdate 钩子函数</span>
  <span class="token function">extractUpdateHooks</span><span class="token punctuation">(</span>updated<span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token comment">// in-config enter guards</span>
  activated<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">m</span> <span class="token operator">=&gt;</span> m<span class="token punctuation">.</span>beforeEnter<span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token comment">// async components</span>
  <span class="token comment">// 异步组件处理</span>
  <span class="token function">resolveAsyncComponents</span><span class="token punctuation">(</span>activated<span class="token punctuation">)</span>
<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>合并的顺序分别是组件内的 beforeRouteLeave、全局的 beforeHooks、组件内的 beforeRouteUpdate、组件内的 beforeEnter 以及异步组件的导航守卫函数。</p> <h3 id="迭代函数-iterator"><a href="#迭代函数-iterator" class="header-anchor">#</a> 迭代函数 iterator</h3> <p>合并 queue 导航守卫任务队列后，申明了 iterator 迭代函数，该函数会作为参数传入 runQueue 方法。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// 申明一个迭代函数，用来处理每个 hook 的 next 回调constiterator= (hook: NavigationGuard, next) =&gt; {</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>pending <span class="token operator">!==</span> route<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">abort</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token comment">// 这就是调用导航守卫函数的地方</span>
    <span class="token comment">// 传入了 route, current，next</span>
    <span class="token function">hook</span><span class="token punctuation">(</span>route<span class="token punctuation">,</span> current<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">to<span class="token operator">:</span> any</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token comment">// next false 终止导航</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>to <span class="token operator">===</span> <span class="token boolean">false</span> <span class="token operator">||</span> <span class="token function">isError</span><span class="token punctuation">(</span>to<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// next(false) -&gt; abort navigation, ensure current URL</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">ensureURL</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
        <span class="token function">abort</span><span class="token punctuation">(</span>to<span class="token punctuation">)</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>
        <span class="token keyword">typeof</span> to <span class="token operator">===</span> <span class="token string">'string'</span> <span class="token operator">||</span>
        <span class="token punctuation">(</span><span class="token keyword">typeof</span> to <span class="token operator">===</span> <span class="token string">'object'</span> <span class="token operator">&amp;&amp;</span>
          <span class="token punctuation">(</span><span class="token keyword">typeof</span> to<span class="token punctuation">.</span>path <span class="token operator">===</span> <span class="token string">'string'</span> <span class="token operator">||</span> <span class="token keyword">typeof</span> to<span class="token punctuation">.</span>name <span class="token operator">===</span> <span class="token string">'string'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 传入了 url 进行路由跳转</span>
        <span class="token comment">// next('/') or next({ path: '/' }) -&gt; redirect</span>
        <span class="token function">abort</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> to <span class="token operator">===</span> <span class="token string">'object'</span> <span class="token operator">&amp;&amp;</span> to<span class="token punctuation">.</span>replace<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>to<span class="token punctuation">)</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>to<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// confirm transition and pass on the value</span>
        <span class="token comment">// next step(index + 1)</span>
        <span class="token function">next</span><span class="token punctuation">(</span>to<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">abort</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br></div></div><p>iterator 迭代函数接收 hook 函数、next 回调作为参数，在函数内部会用 try catch 包裹 hook 函数的调用，这里就是我们执行导航守卫函数的地方，传入了 route、current，以及 next 回调。</p> <p>在 next 回调中， 会对传入的 to 参数进行判断，分别处理，最后的 next(to) 调用的是 runQueue 中的：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token function">fn</span><span class="token punctuation">(</span>queue<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token function">step</span><span class="token punctuation">(</span>index <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>这样会继续调用下一个导航守卫。</p> <h3 id="递归调用任务队列-runqueue"><a href="#递归调用任务队列-runqueue" class="header-anchor">#</a> 递归调用任务队列 runQueue</h3> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">/* @flow */</span><span class="token comment">// 从第一个开始，递归调用任务队列exportfunctionrunQueue(</span>
  queue<span class="token operator">:</span> Array<span class="token operator">&lt;</span><span class="token operator">?</span>NavigationGuard<span class="token operator">&gt;</span><span class="token punctuation">,</span>
  fn<span class="token operator">:</span> Function<span class="token punctuation">,</span>
  cb<span class="token operator">:</span> Function
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token function-variable function">step</span> <span class="token operator">=</span> <span class="token parameter">index</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>index <span class="token operator">&gt;=</span> queue<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">cb</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>queue<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">fn</span><span class="token punctuation">(</span>queue<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token function">step</span><span class="token punctuation">(</span>index <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token function">step</span><span class="token punctuation">(</span>index <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token function">step</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><p>runQueue 函数很简单，就是递归依次执行 queue 任务队列中的导航守卫函数，如果执行完毕，调用 cb 函数。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// 执行合并后的任务队列runQueue(queue, iterator, () =&gt; {</span>
  constpostEnterCbs <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
  <span class="token keyword">const</span> <span class="token function-variable function">isValid</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>current <span class="token operator">===</span> route
  <span class="token comment">// wait until async components are resolved before</span>
  <span class="token comment">// extracting in-component enter guards</span>
  <span class="token comment">// 拿到组件 beforeRouteEnter 钩子函数，合并任务队列</span>
  <span class="token keyword">const</span> enterGuards <span class="token operator">=</span> <span class="token function">extractEnterGuards</span><span class="token punctuation">(</span>activated<span class="token punctuation">,</span> postEnterCbs<span class="token punctuation">,</span> isValid<span class="token punctuation">)</span>
  <span class="token keyword">const</span> queue <span class="token operator">=</span> enterGuards<span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>router<span class="token punctuation">.</span>resolveHooks<span class="token punctuation">)</span>
  <span class="token function">runQueue</span><span class="token punctuation">(</span>queue<span class="token punctuation">,</span> iterator<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>pending <span class="token operator">!==</span> route<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token function">abort</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>pending <span class="token operator">=</span> <span class="token keyword">null</span>
    <span class="token function">onComplete</span><span class="token punctuation">(</span>route<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>router<span class="token punctuation">.</span>app<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>router<span class="token punctuation">.</span>app<span class="token punctuation">.</span><span class="token function">$nextTick</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        postEnterCbs<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">cb</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token function">cb</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><p>这里是正真调用 runQueue 函数的地方，传入了 queue、iterator 迭代函数、cb 回调函数，当 queue 队列的函数都执行完毕，调用传入的 cb 回调函数。</p> <p>在 cb 函数中，调用 extractEnterGuards 函数拿到组件 beforeRouteEnter 钩子函数数组 enterGuards，然后与 resolveHooks 全局解析守卫进行合并，得到新的 queue，再次调用 runQueue 函数，最后调用 onComplete 函数，完成路由的跳转。</p> <h2 id="总结"><a href="#总结" class="header-anchor">#</a> 总结</h2> <p>在这里稍微总结下导航守卫，在 vue-router 中通过数组的形式模拟导航守卫任务队列，在 transitionTo 跳转核心函数中调用确认函数 confirmTransition，在 confirmTransition 函数中会递归 queue 导航守卫任务队列，通过传入 next 函数的参数来判断是否继续执行导航守卫任务，如果 queue 任务全部执行完成，进行路由跳转。</p> <p>感谢 <code>vue-router</code> 中提供的各种导航钩子，让我们能够更加灵活地控制、处理路由。</p> <h3 id="导航守卫的执行顺序"><a href="#导航守卫的执行顺序" class="header-anchor">#</a> 导航守卫的执行顺序</h3> <h3 id="一般路由跳转"><a href="#一般路由跳转" class="header-anchor">#</a> 一般路由跳转</h3> <p>例如从 <code>/</code> <em>Home</em> 页面跳转到 <code>/foo</code> <em>Foo</em>，导航守卫执行顺序大概是这样的。</p> <p><strong>全局导航守卫</strong></p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>router<span class="token punctuation">.</span><span class="token function">beforeEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">to<span class="token punctuation">,</span> <span class="token keyword">from</span><span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'in-global beforeEach hook'</span><span class="token punctuation">)</span>
  <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
router<span class="token punctuation">.</span><span class="token function">beforeResolve</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">to<span class="token punctuation">,</span> <span class="token keyword">from</span><span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'in-global beforeResolve hook'</span><span class="token punctuation">)</span>
  <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
router<span class="token punctuation">.</span><span class="token function">afterEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">to<span class="token punctuation">,</span> <span class="token keyword">from</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'in-global afterEach hook'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p><strong>组件导航守卫</strong></p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>constHome<span class="token operator">=</span> <span class="token punctuation">{</span>
  template<span class="token operator">:</span> <span class="token string">'&lt;div&gt;home&lt;/div&gt;'</span><span class="token punctuation">,</span>
  <span class="token function">beforeRouteEnter</span><span class="token punctuation">(</span><span class="token parameter">to<span class="token punctuation">,</span> <span class="token keyword">from</span><span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'in-component Home beforeRouteEnter hook'</span><span class="token punctuation">)</span>
    <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function">beforeRouteUpdate</span><span class="token punctuation">(</span><span class="token parameter">to<span class="token punctuation">,</span> <span class="token keyword">from</span><span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'in-component Home beforeRouteUpdate hook'</span><span class="token punctuation">)</span>
    <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function">beforeRouteLeave</span><span class="token punctuation">(</span><span class="token parameter">to<span class="token punctuation">,</span> <span class="token keyword">from</span><span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'in-component Home beforeRouteLeave hook'</span><span class="token punctuation">)</span>
    <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">const</span> Foo <span class="token operator">=</span> <span class="token punctuation">{</span>
  template<span class="token operator">:</span> <span class="token string">'&lt;div&gt;foo&lt;/div&gt;'</span><span class="token punctuation">,</span>
  <span class="token function">beforeRouteEnter</span><span class="token punctuation">(</span><span class="token parameter">to<span class="token punctuation">,</span> <span class="token keyword">from</span><span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'in-component Foo beforeRouteEnter hook'</span><span class="token punctuation">)</span>
    <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function">beforeRouteUpdate</span><span class="token punctuation">(</span><span class="token parameter">to<span class="token punctuation">,</span> <span class="token keyword">from</span><span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'in-component Foo beforeRouteUpdate hook'</span><span class="token punctuation">)</span>
    <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function">beforeRouteLeave</span><span class="token punctuation">(</span><span class="token parameter">to<span class="token punctuation">,</span> <span class="token keyword">from</span><span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'in-component Foo beforeRouteLeave hook'</span><span class="token punctuation">)</span>
    <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br></div></div><p><strong>路由导航守卫</strong></p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>constrouter<span class="token operator">=</span><span class="token function">newVueRouter</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  mode<span class="token operator">:</span> <span class="token string">'history'</span><span class="token punctuation">,</span>
  routes<span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      path<span class="token operator">:</span> <span class="token string">'/'</span><span class="token punctuation">,</span>
      component<span class="token operator">:</span> Home<span class="token punctuation">,</span>
      <span class="token function-variable function">beforeEnter</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token function">guardRoute</span><span class="token punctuation">(</span><span class="token parameter">to<span class="token punctuation">,</span> <span class="token keyword">from</span><span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'in-router Home beforeEnter hook'</span><span class="token punctuation">)</span>
        <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      path<span class="token operator">:</span> <span class="token string">'/foo'</span><span class="token punctuation">,</span>
      component<span class="token operator">:</span> Foo<span class="token punctuation">,</span>
      <span class="token function-variable function">beforeEnter</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token function">guardRoute</span><span class="token punctuation">(</span><span class="token parameter">to<span class="token punctuation">,</span> <span class="token keyword">from</span><span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'in-router Foo beforeEnter hook'</span><span class="token punctuation">)</span>
        <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><p><strong>输出</strong></p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">in</span><span class="token operator">-</span>component Home beforeRouteLeave hook
<span class="token keyword">in</span><span class="token operator">-</span>global beforeEach hook
<span class="token keyword">in</span><span class="token operator">-</span>router Foo beforeEnter hook
<span class="token keyword">in</span><span class="token operator">-</span>component Foo beforeRouteEnter hook
<span class="token keyword">in</span><span class="token operator">-</span>global beforeResolve hook
<span class="token keyword">in</span><span class="token operator">-</span>global afterEach hook
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h3 id="组件复用的情况"><a href="#组件复用的情况" class="header-anchor">#</a> 组件复用的情况</h3> <p>在当前路由改变，但是该组件被复用时调用，举例来说，对于一个带有动态参数的路径 <code>/foo/:id</code>，在 <code>/foo/1</code> 和 <code>/foo/2</code> 之间跳转的时候，由于会渲染同样的 Foo 组件，因此组件实例会被复用。beforeRouteUpdate 钩子就会在这个情况下被调用。</p> <p><strong>组件导航守卫</strong></p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>constFoo <span class="token operator">=</span> <span class="token punctuation">{</span>
  template<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;div&gt;Foo&lt;/div&gt;</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
  <span class="token function">created</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'this is Foo created'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function">mounted</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'this is Foo mounted'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function">updated</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'this is Foo updated'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function">destroyed</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'this is Foo destroyed'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function">beforeRouteEnter</span><span class="token punctuation">(</span><span class="token parameter">to<span class="token punctuation">,</span> <span class="token keyword">from</span><span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'in-component Foo beforeRouteEnter hook'</span><span class="token punctuation">)</span>
    <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function">beforeRouteUpdate</span><span class="token punctuation">(</span><span class="token parameter">to<span class="token punctuation">,</span> <span class="token keyword">from</span><span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'in-component Foo beforeRouteUpdate hook'</span><span class="token punctuation">)</span>
    <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function">beforeRouteLeave</span><span class="token punctuation">(</span><span class="token parameter">to<span class="token punctuation">,</span> <span class="token keyword">from</span><span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'in-component Foo beforeRouteLeave hook'</span><span class="token punctuation">)</span>
    <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br></div></div><p><strong>路由导航守卫</strong></p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>constrouter<span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">VueRouter</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  mode<span class="token operator">:</span> <span class="token string">'history'</span><span class="token punctuation">,</span>
  routes<span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token comment">// in-component beforeRouteUpdate hook</span>
    <span class="token punctuation">{</span>
      path<span class="token operator">:</span> <span class="token string">'/foo/:id'</span><span class="token punctuation">,</span>
      component<span class="token operator">:</span> Foo<span class="token punctuation">,</span>
      <span class="token function-variable function">beforeEnter</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token function">guardRoute</span><span class="token punctuation">(</span><span class="token parameter">to<span class="token punctuation">,</span> <span class="token keyword">from</span><span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'in-router Foo beforeEnter hook'</span><span class="token punctuation">)</span>
        <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p><strong>输出</strong></p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">in</span><span class="token operator">-</span>global beforeEach hook
<span class="token keyword">in</span><span class="token operator">-</span>component Foo beforeRouteUpdate hook
<span class="token keyword">in</span><span class="token operator">-</span>global beforeResolve hook
<span class="token keyword">in</span><span class="token operator">-</span>global afterEach hook
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/xn213/Vue/Component/TongYongCom-notification.html" class="prev">
        通用组件 notification 信息提示弹框
      </a></span> <span class="next"><a href="/xn213/Vue/vuex/vuex.html">
        Vuex 简介
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/xn213/assets/js/app.d4906252.js" defer></script><script src="/xn213/assets/js/2.51fac5b8.js" defer></script><script src="/xn213/assets/js/108.8560db9a.js" defer></script>
  </body>
</html>
